---
title: "R script - Caso de estudio Bellabeat"
author: "Jairo Andrés Amaya Muñoz"
date: "2023-02-17"
output: html_document
---

Cargue de librerias

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
```

Direccion de los archivos y 4 grupos de archivos: 
actividad diaria (+ sueño), actividad por hora, peso y ritmo cardiaco.

```{r}
path_pc_local <- "D:/RStudio/Fitabase Data 4.12.16-5.12.16"

activityday <- read_csv(file.path(path_pc_local, "dailyActivity_merged.csv"))
sleepday <- read_csv(file.path(path_pc_local, "sleepDay_merged.csv"))

calorieshour <- read_csv(file.path(path_pc_local, "hourlyCalories_merged.csv"))
stepshour <- read_csv(file.path(path_pc_local, "hourlySteps_merged.csv"))
intensitieshour <- read_csv(file.path(path_pc_local, "hourlyIntensities_merged.csv"))

weight <- read_csv(file.path(path_pc_local, "weightLogInfo_merged.csv"))

heartrate <- read_csv(file.path(path_pc_local, "heartrate_seconds_merged.csv"))
```

Vemos que tenemos registros de 33 usuarios para activityday, calorieshour, stepshour e intensitieshour. 24 usuarios para sleepday, 8 para weight y 14 para heartrate. Si bien algunos registran datos de menos usuarios, pueden llegar a darnos información útil.

Chequeamos si hay valores NA o filas duplicadas.


```{r}

n_distinct(activityday$Id) ; n_distinct(sleepday$Id)
n_distinct(calorieshour$Id) ; n_distinct(stepshour$Id) ; n_distinct(intensitieshour$Id)
n_distinct(weight$Id) ; n_distinct(heartrate$Id)

sum(is.na(activityday)) ; sum(is.na(sleepday))
sum(is.na(calorieshour)) ; sum(is.na(stepshour)) ; sum(is.na(intensitieshour))
sum(is.na(weight)) ; sum(is.na(heartrate))

sum(duplicated(activityday)) ; sum(duplicated(sleepday))
sum(duplicated(calorieshour)) ; sum(duplicated(stepshour)) ; sum(duplicated(intensitieshour))
sum(duplicated(weight)) ; sum(duplicated(heartrate))
```

weight tiene 65 NA y sleepday tiene 3 filas duplicadas.
Dejamos los NA de la columna Fat de weight ya que no afectan, y borramos los 3 duplicados de sleepday.

```{r}
glimpse(weight)
weight %>%
      filter(is.na(Fat))

sleepday <- distinct(sleepday)
sum(duplicated(sleepday))
```

Cambiamos las estampillas de tiempo en texto a formato date o datetime.
Los diarios, el peso y el weight tendrán date y los por hora y el ritmo cardíaco tendrán datetime.

```{r}
activityday <- activityday %>%
  mutate(ActivityDate = date(mdy(ActivityDate))) %>%
  rename(date = ActivityDate)
sleepday <- sleepday %>%
  mutate(SleepDay = date(mdy_hms(SleepDay))) %>%
  rename(date = SleepDay)
weight <- weight %>%
  mutate(Date = date(mdy_hms(Date))) %>%
  rename(date = Date)

calorieshour <- calorieshour %>%
  mutate(ActivityHour = mdy_hms(ActivityHour)) %>%
  rename(datetime = ActivityHour)
stepshour <- stepshour %>%
  mutate(ActivityHour = mdy_hms(ActivityHour)) %>%
  rename(datetime = ActivityHour)
intensitieshour <- intensitieshour %>%
  mutate(ActivityHour = mdy_hms(ActivityHour)) %>%
  rename(datetime = ActivityHour)
heartrate <- heartrate %>%
  mutate(Time = mdy_hms(Time)) %>%
  rename(datetime = Time)

glimpse(calorieshour)
```

Ahora uniremos algunos archivos basados en su usuario Id y estampilla de tiempo.
Entonces quedaremos con activityday, activityhour, weight y heartrate listos y limpios.

```{r}
activityday <- activityday %>%
  left_join(sleepday, by=c("Id", "date"))

activityhour <- calorieshour %>%
  inner_join(stepshour, by=c("Id", "datetime")) %>%
  inner_join(intensitieshour, by=c("Id", "datetime"))
```

Un ultimo vistazo:
Chequeamos que los valores tengan rangos normales.
Todos tienen rangos de valores que son posibles y no irreales.

```{r}
glimpse(activityday)
summary(activityday)

glimpse(activityhour)
summary(activityhour)

glimpse(weight)
summary(weight)

glimpse(heartrate)
summary(heartrate)
```


En este punto ya tenemos los datos listos y preparados.
Empezaremos realizando visualizaciones como:
 - Relación entre distancia y pasos, pasos y calorias y distancia y calorias.
 - Cuanto porcentaje del día se hace actividad y de que intensidad (piechart)
 - Cuales horas del días se hace mas actividad, puede ser por pasos o por calories o actividad (barras)
 - Calidad del sueño vs actividad por intensidades... (un poco difícil)
 - Días de mayor actividad en la semana

Empezamos:

```{r}
ggplot(activityday) +
  geom_point(aes(TotalDistance, TotalSteps)) +
  geom_smooth(aes(TotalDistance, TotalSteps))

ggplot(activityday) +
  geom_point(aes(TotalSteps, Calories)) +
  geom_smooth(aes(TotalSteps, Calories))

ggplot(activityday) +
  geom_point(aes(TotalDistance, Calories, color=TotalSteps)) +
  geom_smooth(aes(TotalDistance, Calories))
```
Acá encontramos la relación de Calorias y Distancia Recorrida, van completamente correlacionados. (esto podría ir en preparación y revisión...)

```{r}
minutos_totales <- sum(activityday$SedentaryMinutes, activityday$LightlyActiveMinutes, activityday$FairlyActiveMinutes, activityday$VeryActiveMinutes)

porcentaje_sedentary <- (sum(activityday$SedentaryMinutes) / minutos_totales) * 100
porcentaje_lightly <- (sum(activityday$LightlyActiveMinutes) / minutos_totales) * 100
porcentaje_fairly <- (sum(activityday$FairlyActiveMinutes) / minutos_totales) * 100
porcentaje_veryactive <- (sum(activityday$VeryActiveMinutes) / minutos_totales) * 100
```

Así tenemos calculados los porcentajes de nivel de intensidad de los días.

Como no contamos con el registro de sueño de todos los días de todos los participantes del estudio, haremos esto:
Hallaremos el promedio de tiempo de sueño diario promedio.
En base a los minutos totales de registro de actividad, calcularemos cuantos días totales tenemos de registro de actividad.

asi hallaremos 

Restaremos el tiempo en que los participantes del estudio durmieron, para esto, como no tenemos registro de todos los días de sueño
de todos los usuarios, determinaremos le tiempo de sueño promedio diario y estimaremos el porcentaje de este en el promedio de dias de los que tenemos
registro de acuerdo 

```{r}
n_distinct(sleepday$Id)
n_distinct(sleepday$date)
#410 registros de sleepday (registros de 410 dias)

n_distinct(activityday$Id)
n_distinct(activityday$date)
#940 registros de activityday (registrso de 940 dias)

minutlos_sueño_promedio_por_registro <- sum(sleepday$TotalMinutesAsleep) / 410

minutlos_sueño_promedio_por_registro / (60)

mean(sleepday$TotalMinutesAsleep) / 60

minutos_totales2 <- sum(activityday$SedentaryMinutes, activityday$LightlyActiveMinutes, activityday$FairlyActiveMinutes, activityday$VeryActiveMinutes) - (mean(sleepday$TotalMinutesAsleep)*940)

porcentaje_sedentary2 <- ((sum(activityday$SedentaryMinutes)- (mean(sleepday$TotalMinutesAsleep)*940)) / minutos_totales2) * 100
porcentaje_lightly2 <- (sum(activityday$LightlyActiveMinutes) / minutos_totales2) * 100
porcentaje_fairly2 <- (sum(activityday$FairlyActiveMinutes) / minutos_totales2) * 100
porcentaje_veryactive2 <- (sum(activityday$VeryActiveMinutes) / minutos_totales2) * 100

```
Hacemos una comprobación para ver que los registros de minutos de actividad son de todo el dia. Efectivamente, la mayoria de ellos por dia e Id son de 24 horas o un poco menos, si el dispositivo inteligente esta apagado, pero esto nos da a entender que en el tiempo sedentary, se incluye el tiempo de sueño. Por esta razon restaremos el tiempo dormido a la actividad diaria en sedentario.
```{r}

activityday %>%
  mutate(semana = isoweek(date), dia = wday(date, abbr = FALSE,
  week_start = getOption("lubridate.week.start", 1),
  )) %>%
  group_by(semana, dia, Id) %>%
  arrange(semana, dia) %>%
  summarize(horas_dia = sum(SedentaryMinutes, LightlyActiveMinutes, FairlyActiveMinutes, VeryActiveMinutes)/60) %>% 
  summarize(n_horas_dia_24 = sum(horas_dia > 23.5))



```



```{r}
porcentajes_pie <- tibble(
  Group=factor(c("Sedentary","Lightly active","Fairly active", "Very active")),
  Percentages=c(porcentaje_sedentary, porcentaje_lightly, porcentaje_fairly, porcentaje_veryactive))

plot_ly(porcentajes_pie, labels = ~Group, values = ~Percentages, type = 'pie',textposition = 'outside',textinfo = 'label+percent') %>% layout(title = 'Nivel de Actividad Promedio por dia',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

porcentajes_pie2 <- tibble(
  Group=factor(c("Sedentary2","Lightly active2","Fairly active2", "Very active2")),
  Percentages=c(porcentaje_sedentary2, porcentaje_lightly2, porcentaje_fairly2, porcentaje_veryactive2))

plot_ly(porcentajes_pie2, labels = ~Group, values = ~Percentages, type = 'pie',textposition = 'outside',textinfo = 'label+percent') %>% layout(title = '<b>Porcentaje de dia dedicado a Nivel de Actividad <b>',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

#con esto le habremos restado al tiempo sedentario el tiempo de sueño
```
Esta grafica es diciente, muestra el porcentaje de tiempo que se dedica a distintos niveles de actividad.
Para mejorar el grafico, podemos restar el tiempo dormido por las personas... debo hacerlo...

Ahora veremos la actividad a lo largo del dia

```{r}
activityhour %>%
    mutate(hora = hour(datetime)) %>%
    group_by(hora) %>%
    summarize(Intensidad_de_actividad = mean(TotalIntensity)) %>%
    ggplot(aes(x=hora, y=Intensidad_de_actividad, fill=Intensidad_de_actividad)) +
        geom_col() +
        scale_fill_gradient(low = "black", high = "darkolivegreen2") +
        labs(x = "Hora del día", y = "Intensidad de Actividad", title="Intensidad de Actividad por hora del día")
```

Ahora miraremos como varia la actividad de acuerdo al día de la semana


[ PODRIA SER BUENO GUIARSE POR LAS CALORIAS, YA QUE AYUDAN A CALCULAR CUANTO SE DEBE COMER ]

```{r}
activityhour %>% 
    mutate(semana = isoweek(datetime), dia = wday(datetime, label=TRUE, abb=FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
    group_by(semana, dia) %>%
    summarize(intensity = mean(TotalIntensity)) %>%
    ggplot(mapping=aes(x=dia, y=semana, fill=intensity)) +
    geom_tile() + 
    geom_text(aes(label=round(intensity, 1)), color="white") +
    labs(x = "Dia de la semana", y = "Semana", title="Intensidad de Actividad dia a dia")

activityhour %>% 
    mutate(semana = isoweek(datetime), dia = wday(datetime, label=TRUE, abb=FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
    group_by(dia) %>%
    summarize(intensity = mean(TotalIntensity)) %>%
    ggplot(mapping=aes(x=dia, y="", fill=intensity)) +
    geom_tile() + 
    geom_text(aes(label=round(intensity, 1)), color="white") +
    labs(x = "Dia de la semana", y = "", title="Intensidad de Actividad promedio por dia de la semana")
```

Ahora analizaremos la relacion entre 


```{r}
active_minutes_vs_calories <- ggplot(data = activityday) + 
  geom_point(aes(x=Calories, y=SedentaryMinutes), color = "mediumseagreen", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x,aes(x=Calories, y=SedentaryMinutes), color = "mediumseagreen", se = FALSE) + 
  
  geom_point(aes(x=Calories, y=LightlyActiveMinutes), color = "orangered3", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x,aes(x=Calories, y=LightlyActiveMinutes, color=LightlyActiveMinutes), color = "orangered3", se = FALSE) + 
  
  geom_point(aes(x=Calories, y=FairlyActiveMinutes), color = "purple3", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x, aes(x=Calories, y=FairlyActiveMinutes), color = "purple3", se = FALSE) +
  
  geom_point(aes(x=Calories, y=VeryActiveMinutes), color = "turquoise1", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x,aes(x=Calories, y=VeryActiveMinutes), color = "turquoise1", se = FALSE) +
  
  labs(x = "Calorias", y = "Minutos de Actividad", title="Calorias vs Minutos de Actividad") +
  
  annotate("text", x=4800, y=160, label="Very Active",     color="black", size=3) +
  annotate("text", x=4800, y=0,   label="Fairly Active",   color="black", size=3) +
  annotate("text", x=4800, y=500, label="Sedentary",       color="black", size=3) +
  annotate("text", x=4800, y=250, label="Lightly  Active", color="black", size=3)
```


