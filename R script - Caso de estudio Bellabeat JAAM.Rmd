---
title: "R script - Caso de estudio Bellabeat"
author: "Jairo Andrés Amaya Muñoz"
date: "2023-02-17"
output: html_document
---

Cargue de librerias

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
```

Dirección de los archivos y cargue de 4 grupos de archivos: 
actividad diaria (+ sueño), actividad por hora, peso y ritmo cardíaco.

```{r}
path_pc_local <- "C:/Users/JairoA/Documents/R_Studio_JAAM_Files/Capstone Project JAAM/Fitabase_Data_04122016-05122016"
path_pc_oficina <- "D:/RStudio/Fitabase Data 4.12.16-5.12.16"

activityday <- read_csv(file.path(path_pc_oficina, "dailyActivity_merged.csv"))
sleepday <- read_csv(file.path(path_pc_oficina, "sleepDay_merged.csv"))

calorieshour <- read_csv(file.path(path_pc_oficina, "hourlyCalories_merged.csv"))
stepshour <- read_csv(file.path(path_pc_oficina, "hourlySteps_merged.csv"))
intensitieshour <- read_csv(file.path(path_pc_oficina, "hourlyIntensities_merged.csv"))

weight <- read_csv(file.path(path_pc_oficina, "weightLogInfo_merged.csv"))

heartrate <- read_csv(file.path(path_pc_oficina, "heartrate_seconds_merged.csv"))
```

Revisamos que los archivos se hayan subido correctamente.

Revisamos la variable de Id para saber cuantos usuarios tenemos, también si hay valores NA y si hay registros duplicados.

```{r}
n_distinct(activityday$Id) ; n_distinct(sleepday$Id)
n_distinct(calorieshour$Id) ; n_distinct(stepshour$Id) ; n_distinct(intensitieshour$Id)
n_distinct(weight$Id) ; n_distinct(heartrate$Id)

sum(is.na(activityday)) ; sum(is.na(sleepday))
sum(is.na(calorieshour)) ; sum(is.na(stepshour)) ; sum(is.na(intensitieshour))
sum(is.na(weight)) ; sum(is.na(heartrate))

sum(duplicated(activityday)) ; sum(duplicated(sleepday))
sum(duplicated(calorieshour)) ; sum(duplicated(stepshour)) ; sum(duplicated(intensitieshour))
sum(duplicated(weight)) ; sum(duplicated(heartrate))
```

Vemos que tenemos registros de 33 usuarios para activityday, calorieshour, stepshour e intensitieshour. 
24 usuarios para sleepday, 8 para weight y 14 para heartrate. 
Si bien algunos archivos registran datos de menos usuarios, pueden llegar a darnos información útil.

Ademas, encontramos que weight tiene 65 NA y sleepday tiene 3 filas duplicadas.

Dejamos los NA ya que pertenecen a la columna Fat de weight y no afectan, y borramos los 3 duplicados de sleepday.

```{r}
glimpse(weight)
weight %>%
      filter(is.na(Fat))

sleepday <- distinct(sleepday)
sum(duplicated(sleepday))
```

Ahora, cambiamos las estampillas de tiempo que están en formato de texto a formato date o datetime.
Los diarios, el peso y el weight tendrán date y los por hora y el ritmo cardíaco tendrán datetime.

```{r}
activityday <- activityday %>%
  mutate(ActivityDate = date(mdy(ActivityDate))) %>%
  rename(date = ActivityDate)
sleepday <- sleepday %>%
  mutate(SleepDay = date(mdy_hms(SleepDay))) %>%
  rename(date = SleepDay)
weight <- weight %>%
  mutate(Date = date(mdy_hms(Date))) %>%
  rename(date = Date)

calorieshour <- calorieshour %>%
  mutate(ActivityHour = mdy_hms(ActivityHour)) %>%
  rename(datetime = ActivityHour)
stepshour <- stepshour %>%
  mutate(ActivityHour = mdy_hms(ActivityHour)) %>%
  rename(datetime = ActivityHour)
intensitieshour <- intensitieshour %>%
  mutate(ActivityHour = mdy_hms(ActivityHour)) %>%
  rename(datetime = ActivityHour)
heartrate <- heartrate %>%
  mutate(Time = mdy_hms(Time)) %>%
  rename(datetime = Time)
```

Las fechas están en un formato correcto para facilitar su uso mas adelante, también aprovechamos el Id en conjunto con la estampilla de tiempo como identificación única de cada registro.

Con esto podemos unir tablas de datos para facilitar el manejo. Quedaremos con activityday, incluida la información de sleepday, activityhour uniendo las 3 de actividad por hora y weight y heartrate.

```{r}
activityday <- activityday %>%
  left_join(sleepday, by=c("Id", "date"))

activityhour <- calorieshour %>%
  inner_join(stepshour, by=c("Id", "datetime")) %>%
  inner_join(intensitieshour, by=c("Id", "datetime"))
```

Añadiremos unas variables adicionales para ordenar los datos después:
semana y dia para activityday y semana, dia y hora para activityhour.

```{r}
activityday <- activityday %>%
  mutate(semana=isoweek(date), dia=wday(date)) %>%
  relocate(Id, date, semana, dia)

activityhour <- activityhour %>%
  mutate(semana=isoweek(datetime), dia=wday(datetime), hora=hour(datetime)) %>%
  relocate(Id, datetime, semana, dia, hora)
```


Echamos un ultimo vistazo después de unidas y reordenadas para que los valores tengan rangos normales.  Deben estar ordenados, limpios y listos.

```{r}
glimpse(activityday)
summary(activityday)

glimpse(activityhour)
summary(activityhour)

glimpse(weight)
summary(weight)

glimpse(heartrate)
summary(heartrate)
```

Todos tienen rangos de valores que son posibles y no irreales. Por lo que las tablas a analizar están listas.

En este punto ya tenemos los datos listos y preparados.
Empezaremos realizando visualizaciones como:
 - Relación entre distancia y pasos, pasos y calorias y distancia y calorias.
 - Cuanto porcentaje del día se hace actividad y de que intensidad (piechart)
 - Cuales horas del días se hace mas actividad, puede ser por pasos o por calories o actividad (barras)
 - Calidad del sueño vs actividad por intensidades... (un poco difícil)
 - Días de mayor actividad en la semana


Ahora empezamos a realizar gráficas que nos permitan dilucidar la información que contiene nuestros datos y que con esto podamos caracterizar a los usuarios de los dispositivos FitBit o de cualquier dispositivo de bio-monitoreo inteligente.


En primer lugar queremos ver la relación entre Calorias, Pasos dados y Distancia recorrida.

```{r}
ggplot(activityday, aes(x=TotalSteps, y=TotalDistance)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Numero de Pasos", y = "Distancia Recorrida", title="Numero de Pasos vs Distancia Recorrida")

ggplot(data=activityday, aes(x=TotalSteps, y=Calories)) +
        geom_point(mapping=aes(color=TotalDistance)) +
        geom_smooth() +
        labs(x = "Numero de Pasos", y = "Calorias", color="Distancia Recorrida", title="Numero de Pasos vs Calorias vs Distancia Recorrida")

ggplot(data=activityday, aes(x=TotalDistance, y=Calories)) +
        geom_point(mapping=aes(color=TotalDistance)) +
        geom_smooth()
```

Como es de esperarse a cuanto mas pasos mas distancia y mas calorías, van correlacionadas las tres variables, aunque midan cosas distintas, al final pueden indicar el nivel de actividad fisica de una persona.
(esto podría ir en preparación y revisión...)


Queremos calcular el porcentaje del dia dedicado a cada nivel de actividad.

Pero extraeremos el tiempo de sueño. Como no contamos con el registro de sueño de todos los días de todos los participantes del estudio, hacemos esto:
Hallaremos el promedio de tiempo de sueño diario promedio, en base a los minutos totales de registro de actividad, calcularemos cuantos días totales tenemos de registro de actividad.

Restaremos el tiempo en que los participantes del estudio durmieron, para esto, como no tenemos registro de todos los días de sueño
de todos los usuarios, determinaremos le tiempo de sueño promedio diario y estimaremos el porcentaje de este en el promedio de dias de los que tenemos
registro de acuerdo 

```{r}
n_distinct(sleepday$Id)
n_distinct(sleepday$date)
#410 registros de sleepday (registros de 410 dias)

n_distinct(activityday$Id)
n_distinct(activityday$date)
#940 registros de activityday (registrso de 940 dias)

minutlos_sueño_promedio_por_registro <- sum(sleepday$TotalMinutesAsleep) / 410

minutlos_sueño_promedio_por_registro / (60)

mean(sleepday$TotalMinutesAsleep) / 60

minutos_totales2 <- sum(activityday$SedentaryMinutes, activityday$LightlyActiveMinutes, activityday$FairlyActiveMinutes, activityday$VeryActiveMinutes) - (mean(sleepday$TotalMinutesAsleep)*940)

porcentaje_sedentary <- ((sum(activityday$SedentaryMinutes)- (mean(sleepday$TotalMinutesAsleep)*940)) / minutos_totales2) * 100
porcentaje_lightly <- (sum(activityday$LightlyActiveMinutes) / minutos_totales2) * 100
porcentaje_fairly <- (sum(activityday$FairlyActiveMinutes) / minutos_totales2) * 100
porcentaje_veryactive <- (sum(activityday$VeryActiveMinutes) / minutos_totales2) * 100

```
Hacemos una comprobación para ver que los registros de minutos de actividad son de todo el dia. Efectivamente, la mayoria de ellos por dia e Id son de 24 horas o un poco menos, si el dispositivo inteligente esta apagado, pero esto nos da a entender que en el tiempo sedentary, se incluye el tiempo de sueño. Por esta razon restaremos el tiempo dormido a la actividad diaria en sedentario.
```{r}

activityday %>%
  mutate( semana = isoweek(date), 
          dia = wday(date, abbr = FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
  group_by(semana, dia, Id) %>%
  arrange(semana, dia) %>%
  summarize(horas_dia = sum(SedentaryMinutes, LightlyActiveMinutes, FairlyActiveMinutes, VeryActiveMinutes)/60)

activityday %>%
  mutate( semana = isoweek(date), 
          dia = wday(date, abbr = FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
  group_by(semana, dia, Id) %>%
  arrange(semana, dia) %>%
  summarize(horas_dia = sum(SedentaryMinutes, LightlyActiveMinutes, FairlyActiveMinutes, VeryActiveMinutes)/60) %>%
  filter( horas_dia != 24)
```
En primer lugar, comprobamos la relación existente entre las calorías, los pasos y la distancia.

Vemos que existe una correlación positiva entre las calorías quemadas y los pasos dados, los que al mismo tiempo se relacionan positivamente con la distancia recorrida con el usuario, como es de esperarse.

```{r}
porcentajes_pie <- tibble(
  Group=factor(c("Sedentary","Lightly active","Fairly active", "Very active")),
  Percentages=c(porcentaje_sedentary, porcentaje_lightly, porcentaje_fairly, porcentaje_veryactive))

plot_ly(porcentajes_pie, labels = ~Group, values = ~Percentages, type = 'pie',textposition = 'outside',textinfo = 'label+percent') %>% layout(title = '<b>Porcentaje de dia dedicado a Nivel de Actividad <b>',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

#con esto le habremos restado al tiempo sedentario el tiempo de sueño
```
Esta gráfica es diciente, muestra el porcentaje de tiempo que se dedica a distintos niveles de actividad.
Para mejorar el gráfico, podemos restar el tiempo dormido por las personas... debo hacerlo...

Ahora veremos la actividad a lo largo del día

```{r}
activityhour %>%
    mutate(hora = hour(datetime)) %>%
    group_by(hora) %>%
    summarize(Intensidad_de_actividad = mean(TotalIntensity)) %>%
    ggplot(aes(x=hora, y=Intensidad_de_actividad, fill=Intensidad_de_actividad)) +
        geom_col() +
        scale_fill_gradient(low = "steelblue4", high = "darkolivegreen2") +
        labs(x = "Hora del día", y = "Intensidad de Actividad", title="Intensidad de Actividad por hora del día")
```

Ahora miraremos como varia la actividad de acuerdo al día de la semana


[ PODRIA SER BUENO GUIARSE POR LAS CALORIAS, YA QUE AYUDAN A CALCULAR CUANTO SE DEBE COMER ]

```{r}
activityhour %>% 
    mutate(semana = isoweek(datetime), dia = wday(datetime, label=TRUE, abb=FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
    group_by(semana, dia) %>%
    summarize(intensity = mean(TotalIntensity)) %>%
    ggplot(mapping=aes(x=dia, y=semana, fill=intensity)) +
    geom_tile() + 
    geom_text(aes(label=round(intensity, 1)), color="white") +
    scale_fill_gradient(low = "steelblue", high = "mediumseagreen") +
    labs(x = "Dia de la semana", y = "Semana", title="Intensidad de Actividad dia a dia")

activityhour %>% 
    mutate(semana = isoweek(datetime), dia = wday(datetime, label=TRUE, abb=FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
    group_by(dia) %>%
    summarize(mean_calories = mean(Calories)) %>%
    ggplot(mapping=aes(x=dia, y="", fill=mean_calories)) +
    geom_tile() + 
    geom_text(aes(label=round(mean_calories, 1)), color="white") +
    scale_fill_gradient(low = "steelblue", high = "mediumseagreen") +
    
    labs(x = "Dia de la semana", y = "", title="Intensidad de Actividad promedio por dia de la semana")

activityhour %>% 
    mutate(semana = isoweek(datetime), dia = wday(datetime, label=TRUE, abb=FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
    ggplot(mapping=aes(x=dia, y=Calories)) +
    geom_boxplot() + 
    scale_fill_gradient(low = "steelblue", high = "mediumseagreen") +
    
    labs(x = "Dia de la semana", y = "", title="Intensidad de Actividad promedio por dia de la semana")
```
```{r}
ggplot(activityhour) +
  geom_point(aes(Calories, TotalIntensity))

activityhour %>% 
    mutate(semana = isoweek(datetime), dia = wday(datetime, label=TRUE, abb=FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
    group_by(semana, dia) %>%
    summarize(mean_calories = mean(Calories)) %>%
    ggplot(mapping=aes(x=dia, y=semana, fill=mean_calories)) +
    geom_tile() + 
    geom_text(aes(label=round(mean_calories, 1)), color="white") +
    scale_fill_gradient(low = "steelblue", high = "mediumseagreen") +
    labs(x = "Dia de la semana", y = "Semana", title="Calorias dia a dia")

activityhour %>% 
    mutate(semana = isoweek(datetime), dia = wday(datetime, label=TRUE, abb=FALSE, week_start = getOption("lubridate.week.start", 1))) %>%
    group_by(dia) %>%
    summarize(mean_calories = mean(Calories)) %>%
    ggplot(mapping=aes(x=dia, y="", fill=mean_calories)) +
    geom_tile() + 
    geom_text(aes(label=round(mean_calories, 1)), color="white") +
    scale_fill_gradient(low = "steelblue", high = "mediumseagreen") +
    
    labs(x = "Dia de la semana", y = "", title="Intensidad de Actividad promedio por dia de la semana")
```

Ahora analizaremos la relacion entre 


```{r}
active_minutes_vs_calories <- ggplot(data = activityday) + 
  geom_point(aes(x=Calories, y=SedentaryMinutes), color = "mediumseagreen", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x,aes(x=Calories, y=SedentaryMinutes), color = "mediumseagreen", se = FALSE) + 
  
  geom_point(aes(x=Calories, y=LightlyActiveMinutes), color = "orangered3", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x,aes(x=Calories, y=LightlyActiveMinutes, color=LightlyActiveMinutes), color = "orangered3", se = FALSE) + 
  
  geom_point(aes(x=Calories, y=FairlyActiveMinutes), color = "purple3", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x, aes(x=Calories, y=FairlyActiveMinutes), color = "purple3", se = FALSE) +
  
  geom_point(aes(x=Calories, y=VeryActiveMinutes), color = "turquoise1", alpha = 1/4) +
  geom_smooth(method = loess,formula =y ~ x,aes(x=Calories, y=VeryActiveMinutes), color = "turquoise1", se = FALSE) +
  
  labs(x = "Calorias", y = "Minutos de Actividad", title="Calorias vs Minutos de Actividad") +
  
  annotate("text", x=4800, y=160, label="Very Active",     color="black", size=3) +
  annotate("text", x=4800, y=0,   label="Fairly Active",   color="black", size=3) +
  annotate("text", x=4800, y=500, label="Sedentary",       color="black", size=3) +
  annotate("text", x=4800, y=250, label="Lightly  Active", color="black", size=3)

active_minutes_vs_calories
```
Lo siguiente es hacer un análisis del sueño.


avanza...

```{r}
activityhour %>% group_by(Id, date(datetime)) %>% summarize(sum(TotalIntensity)/60)

```
